version: 2.1

jobs:
  build:
    docker:
      - image: cimg/android:2025.08
    steps:
      - checkout

      # Install system Gradle (only needed if wrapper jar is missing)
      - run:
          name: Install Gradle (fallback only)
          command: |
            sudo apt-get update
            sudo apt-get install -y gradle
            gradle --version

      # Restore caches
      - restore_cache:
          keys:
            - gradle-wrapper-v1-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-wrapper-v1-
      - restore_cache:
          keys:
            - gradle-deps-v1-{{ checksum "build.gradle.kts" }}-{{ checksum "gradle.properties" }}
            - gradle-deps-v1-
      - restore_cache:
          keys:
            - maven-v1-{{ checksum "gradle.properties" }}
            - maven-v1-

      # Ensure wrapper exists
      - run:
          name: Ensure Gradle Wrapper
          command: |
            if [ ! -f "./gradlew" ] || [ ! -f "./gradle/wrapper/gradle-wrapper.jar" ]; then
              echo "Gradle wrapper missing â€” regenerating..."
              gradle wrapper
            fi
            chmod +x ./gradlew

      # Build using wrapper (downloads exact version from gradle-wrapper.properties)
      - run: ./gradlew assembleDist

      # Save caches
      - save_cache:
          key: gradle-wrapper-v1-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
          paths:
            - ~/.gradle/wrapper/dists
      - save_cache:
          key: gradle-deps-v1-{{ checksum "build.gradle.kts" }}-{{ checksum "gradle.properties" }}
          paths:
            - ~/.gradle/caches
      - save_cache:
          key: maven-v1-{{ checksum "gradle.properties" }}
          paths:
            - ~/.m2
      - save_cache:
          key: android-v1
          paths:
            - ~/.android
      - save_cache:
          key: konan-v1
          paths:
            - ~/.konan
